<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List</title>
    <!-- Bootstrap CSS (you can include it inline as well if needed) -->
    <style>
        /* Bootstrap CSS code */
    </style>
    <style>
        /* Custom CSS styles */
        .todo-item {
            margin-bottom: 10px;
        }

        .delete-btn {
            margin-left: 8px;
            /* Adjust as needed */
        }

        .password-input {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mt-4">Todo List</h2>
        <div id="passwordPrompt" style="display: none;">
            <input type="password" class="form-control password-input" placeholder="Enter password" id="passwordInput">
            <button class="btn btn-primary" type="button" id="passwordSubmitBtn">Submit</button>
        </div>
        <div id="todoListContainer" style="display: none;">
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Add new task" id="newTaskInput">
                <button class="btn btn-primary" type="button" id="addTaskBtn">Add Task</button>
            </div>
            <ul class="list-group" id="todoList">
                <!-- Todo items will be added dynamically here -->
            </ul>
        </div>
    </div>

    <!-- Inline JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var passwordInput = document.getElementById('passwordInput');
            var passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
            var passwordPrompt = document.getElementById('passwordPrompt');
            var todoListContainer = document.getElementById('todoListContainer');

            passwordSubmitBtn.addEventListener('click', function () {
                var enteredPassword = passwordInput.value.trim();
            //    console.log(enteredPassword)
                fetchPasswordFromAPI(enteredPassword)
                    .then(response => {
                        if (response.ok) {
                            passwordPrompt.style.display = 'none';
                            todoListContainer.style.display = 'block';
                            // Store timestamp in local storage
                            localStorage.setItem('authTimestamp', Date.now());
                            // Automatically refresh after 5 minutes
                            setTimeout(function () {
                                localStorage.removeItem('authTimestamp');
                                passwordPrompt.style.display = 'block'; // Show password prompt after expiration
                                todoListContainer.style.display = 'none'; // Hide todo list after expiration
                            }, 5 * 60 * 1000); // 5 minutes in milliseconds
                            fetchTodoItems();
                        } else {
                            alert('Incorrect password. Please try again.');
                            passwordInput.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching password:', error);
                        alert('Failed to fetch password. Please try again later.');
                    });
            });

            // Function to fetch todo items from backend
            function fetchTodoItems() {
                fetch('/api/todo')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(todo => addTask(todo)); // Add each fetched todo item to the UI
                    })
                    .catch(error => console.error('Error fetching todo items:', error));
            }

            // Function to fetch password from API
            function fetchPasswordFromAPI(password) {
             //   console.log('Password:', password);
                return fetch('/api/todo/pass', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
            }

            // Function to add a new todo task
            function addTask(task) {
                var listItem = document.createElement('li');
                listItem.className = 'list-group-item todo-item';

                // Create span for task name
                var taskNameSpan = document.createElement('span');
                taskNameSpan.textContent = task.taskName;
                taskNameSpan.style.marginRight = '10px'; // Add margin to the right of the text

                // Add delete button for each todo item
                var deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-danger delete-btn';
                deleteButton.dataset.id = task.id;
                deleteButton.addEventListener('click', function () {
                    deleteTask(task.id);
                });

                // Append task name and delete button to the todo item
                listItem.appendChild(taskNameSpan);
                listItem.appendChild(deleteButton);
                document.getElementById('todoList').appendChild(listItem);
            }
         function sendTaskToBackend(taskName) {
               // console.log('Task name:', taskName); // Log the task name being sent to the backend
                fetch('/api/todo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ taskName: taskName })
                })
                    .then(response => {
                        //console.log('Response from server:', response); // Log the response from the server
                        if (response.ok) {
                                 location.reload(); 
                            return response.json(); // Extract JSON body content from response
                        } else {
                            console.error('Failed to add task. Server returned:', response.status, response.statusText);
                            throw new Error('Failed to add task');
                        }
                    })
                    .then(data => {
                        if (!data) {
                            console.error('Empty response data received');
                            throw new Error('Empty response data');
                        }
                        addTask(data); // Add the newly created task to the UI
                        document.getElementById('newTaskInput').value = ''; // Clear input field after adding task
                    })
                    .catch(error => console.error('Error adding task:', error));
            }



            // Function to delete a todo task by its ID
            function deleteTask(taskId) {
               // console.log('Deleting task with ID:', taskId);
                fetch('/api/todo/' + taskId, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                          //  console.log('Task deleted successfully');
                            location.reload();
                            // Refresh the todo list after deleting task

                        } else {
                            console.error('Failed to delete task:', response.status);
                            location.reload();
                        }
                    })
                    .catch(error => console.error('Error deleting task:', error));
            }

            // Add task when clicking the "Add Task" button
            document.getElementById('addTaskBtn').addEventListener('click', function () {
                var newTaskInput = document.getElementById('newTaskInput');
                var taskName = newTaskInput.value.trim();
                if (taskName !== '') {
                    sendTaskToBackend(taskName);
                    newTaskInput.value = ''; // Clear input field after adding task
                }
            });

            // Add task when pressing Enter key in the input field
            document.getElementById('newTaskInput').addEventListener('keypress', function (event) {
                if (event.which === 13) { // Enter key
                    document.getElementById('addTaskBtn').click(); // Trigger click event of Add Task button
                }
            });

            // Check if authentication timestamp is within 5 minutes
            var authTimestamp = localStorage.getItem('authTimestamp');
            if (authTimestamp && Date.now() - authTimestamp <= 5 * 60 * 1000) {
                // If timestamp is within 5 minutes, proceed without prompting for password
                todoListContainer.style.display = 'block';
                fetchTodoItems();
            } else {
                // If timestamp is expired or not present, prompt for password
                passwordPrompt.style.display = 'block';
            }
        });
    </script>

</body>

</html>